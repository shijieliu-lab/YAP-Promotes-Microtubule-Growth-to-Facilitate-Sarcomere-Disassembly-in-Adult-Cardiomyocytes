# Combined RNA-seq midstream and downstream analysis for rat YAP5SA vs YAPS94A
# Author: Feng (based on Jia-Hua Qu's pipeline)

# Load libraries
library(DESeq2)
library(tidyverse)
library(pheatmap)
library(RColorBrewer)
library(Rtsne)
library(EnhancedVolcano)
library(clusterProfiler)
library(org.Rn.eg.db)
library(tibble)

# Set working directory
setwd("/Users/zha5dp/Desktop/YAP5SA_and_S94A_RNA_seq_data_analysis")

# Read data
counts <- read.csv("gene_count_matrix.csv", row.names = 1)
meta <- data.frame(row.names = colnames(counts),
                   condition = rep(c("YAP5SA", "YAPS94A"), each = 2))

dds <- DESeqDataSetFromMatrix(countData = round(counts),
                              colData = meta,
                              design = ~ condition)
dds <- dds[rowSums(counts(dds)) > 10, ]
dds <- DESeq(dds)

# Save for reuse
saveRDS(dds, "dds.rds")

# Normalization
vsd <- vst(dds)
rld <- rlog(dds)

# Boxplot
vst_data <- assay(vsd) %>%
  as.data.frame() %>%
  rownames_to_column("gene") %>%
  pivot_longer(-gene, names_to = "sample", values_to = "vst") %>%
  left_join(meta %>% rownames_to_column("sample"), by = "sample")

ggplot(vst_data, aes(x = sample, y = vst, fill = condition)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 90)) +
  ggtitle("Boxplot of VST normalized counts")
ggsave("boxplot_vst.pdf")

# Sample distance heatmap
sampleDists <- dist(t(assay(vsd)))
pheatmap(as.matrix(sampleDists), annotation_col = meta)
ggsave("sample_distance_heatmap.pdf")

# PCA
p <- plotPCA(vsd, intgroup = "condition")
ggsave("PCA_plot.pdf", p)

# t-SNE (only if samples > 3)
if (ncol(counts) > 3) {
  set.seed(123)
  tsne <- Rtsne(t(assay(vsd)[1:1000, ]), perplexity = 1)
  tsne_df <- data.frame(tsne$Y)
  colnames(tsne_df) <- c("Dim1", "Dim2")
  tsne_df$condition <- meta$condition
  ggplot(tsne_df, aes(x = Dim1, y = Dim2, color = condition)) + geom_point()
  ggsave("tsne_plot.pdf")
}

# DEG Analysis
res <- results(dds, contrast = c("condition", "YAP5SA", "YAPS94A"))
res_df <- as.data.frame(res) %>%
  rownames_to_column("raw_gene") %>%
  mutate(gene = sub(".*\\|", "", raw_gene)) %>%
  filter(!is.na(padj)) %>%
  arrange(padj)


# Save DEG table
write.csv(res_df, "DEGs_YAP5SA_vs_YAPS94A.csv")

# Volcano plot-No gene lable
EnhancedVolcano(res_df,
                lab = NA,
                x = "log2FoldChange",
                y = "padj",
                title = "YAP5SA vs YAPS94A",
                subtitle = "No gene labels")
ggsave("volcano_no_labels.pdf")
# Volcano plot-gene lable
EnhancedVolcano(res_df,
                lab = res_df$gene,
                x = "log2FoldChange",
                y = "padj",
                title = "YAP5SA vs YAPS94A",
                subtitle = "Clean gene names")
ggsave("volcano_clean_labels.pdf")

# Enrichment
gene_map <- bitr(res_df$gene, fromType = "SYMBOL", toType = "ENTREZID", OrgDb = org.Rn.eg.db)

entrez_up <- gene_map$ENTREZID[res_df$log2FoldChange > 1 & res_df$padj < 0.05]
entrez_down <- gene_map$ENTREZID[res_df$log2FoldChange < -1 & res_df$padj < 0.05]

#Heatmap of expression of significantly changed genes
sig_genes <- res_df$raw_gene[res_df$padj < 0.05]
mat <- assay(vsd)[sig_genes, ]
mat_scaled <- t(scale(t(mat)))
anno_col <- data.frame(Condition = meta$condition)
rownames(anno_col) <- rownames(meta)
pheatmap(mat_scaled,
         annotation_col = anno_col,
         show_rownames = FALSE,
         cluster_rows = TRUE,
         cluster_cols = TRUE,
         color = colorRampPalette(c("blue", "white", "red"))(100),
         main = "YAP5SA vs YAPS94A - DEGs FDR < 0.05")

png("DEG_heatmap.png", width = 540, height = 798, res = 600)  # 600 dpi high resolution
pheatmap(mat,
         scale = "row",
         annotation_col = anno_col,
         show_rownames = FALSE,
         cluster_rows = TRUE,
         cluster_cols = TRUE,
         color = colorRampPalette(c("blue","white","red"))(100),
         main = "YAP5SA vs YAPS94A - DEGs FDR < 0.05")
dev.off()



# KEGG
kegg_up <- enrichKEGG(gene = entrez_up, organism = "rno")
kegg_down <- enrichKEGG(gene = entrez_down, organism = "rno")
dotplot(kegg_up) + ggtitle("KEGG Enrichment - Upregulated")
ggsave("kegg_up.pdf")
dotplot(kegg_down) + ggtitle("KEGG Enrichment - Downregulated")
ggsave("kegg_down.pdf")

# GO BP
go_up <- enrichGO(gene = entrez_up, OrgDb = org.Rn.eg.db, ont = "BP")
go_down <- enrichGO(gene = entrez_down, OrgDb = org.Rn.eg.db, ont = "BP")
dotplot(go_up) + ggtitle("GO BP - Upregulated")
ggsave("go_bp_up.pdf")
dotplot(go_down) + ggtitle("GO BP - Downregulated")
ggsave("go_bp_down.pdf")
